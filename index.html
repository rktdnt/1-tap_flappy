<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Shape</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    #gameContainer {
      position: relative;
    }
    canvas {
      background: linear-gradient(#4d9fff, #88ddff);
      border: 2px solid #fff;
      border-radius: 10px;
      display: block;
    }
    #overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      pointer-events: none;
    }
    #info {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    #controls {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      opacity: 0.8;
      text-align: center;
      max-width: 90%;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="game" width="480" height="640"></canvas>
    <div id="overlay">
      <h1 id="titleText">Flappy Shape</h1>
      <p id="subText">Tekan SPASI atau TAP untuk mulai<br/>1 = Bulat · 2 = Kotak · 3 = Segitiga</p>
    </div>
    <div id="info">
      <div>Skor: <span id="scoreText">0</span></div>
      <div>Bentuk: <span id="shapeText">Bulat</span></div>
    </div>
    <div id="controls">
      Kontrol: SPASI / TAP untuk lompat · 1/2/3 ganti bentuk · ENTER restart
    </div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const overlay = document.getElementById("overlay");
    const titleText = document.getElementById("titleText");
    const subText = document.getElementById("subText");
    const scoreText = document.getElementById("scoreText");
    const shapeText = document.getElementById("shapeText");

    const W = canvas.width;
    const H = canvas.height;

    // Player
    const player = {
      x: 100,
      y: H / 2,
      radius: 18,
      vy: 0,
      gravity: 0.45,
      flapStrength: -8.5,
      shape: "circle" // circle | square | triangle
    };

    // Pipes (obstacles)
    const pipes = [];
    const pipeWidth = 70;
    const gapHeight = 150;
    const pipeSpacing = 260;
    const pipeSpeed = 3;

    let lastPipeX = W;
    const shapes = ["circle", "square", "triangle"];

    let score = 0;
    let gameRunning = false;
    let gameOver = false;

    function resetGame() {
      player.y = H / 2;
      player.vy = 0;
      player.shape = "circle";
      score = 0;
      pipes.length = 0;
      lastPipeX = W + 200;
      scoreText.textContent = score;
      updateShapeText();
      gameOver = false;
      gameRunning = false;
      overlay.style.pointerEvents = "none";
      titleText.textContent = "Flappy Shape";
      subText.innerHTML = "Tekan SPASI atau TAP untuk mulai<br/>1 = Bulat · 2 = Kotak · 3 = Segitiga";
      overlay.style.opacity = 1;
    }

    function spawnPipe() {
      const margin = 80;
      const gapY = margin + Math.random() * (H - 2 * margin - gapHeight);
      const requiredShape = shapes[Math.floor(Math.random() * shapes.length)];
      pipes.push({
        x: W + 50,
        gapY,
        gapHeight,
        requiredShape,
        passed: false
      });
    }

    function flap() {
      if (!gameRunning && !gameOver) {
        gameRunning = true;
        overlay.style.opacity = 0;
      }
      if (!gameOver) {
        player.vy = player.flapStrength;
      }
    }

    function changeShape(shapeIndex) {
      if (shapeIndex < 0 || shapeIndex >= shapes.length) return;
      player.shape = shapes[shapeIndex];
      updateShapeText();
    }

    function updateShapeText() {
      switch (player.shape) {
        case "circle":
          shapeText.textContent = "Bulat";
          break;
        case "square":
          shapeText.textContent = "Kotak";
          break;
        case "triangle":
          shapeText.textContent = "Segitiga";
          break;
      }
    }

    function update() {
      if (gameRunning && !gameOver) {
        // Physics
        player.vy += player.gravity;
        player.y += player.vy;

        // Boundaries
        if (player.y - player.radius < 0 || player.y + player.radius > H) {
          triggerGameOver();
        }

        // Pipes logic
        if (pipes.length === 0 || lastPipeX - pipes[pipes.length - 1].x >= pipeSpacing) {
          spawnPipe();
        }

        // Move and check pipes
        for (let i = pipes.length - 1; i >= 0; i--) {
          const p = pipes[i];
          p.x -= pipeSpeed;

          // Collision check
          const withinX =
            player.x + player.radius > p.x &&
            player.x - player.radius < p.x + pipeWidth;

          if (withinX) {
            const inGap =
              player.y - player.radius > p.gapY &&
              player.y + player.radius < p.gapY + p.gapHeight;

            // Kalau tidak di area gap → nabrak
            if (!inGap) {
              triggerGameOver();
            } else {
              // Di gap tapi bentuk salah → dianggap nabrak juga
              if (player.shape !== p.requiredShape) {
                triggerGameOver();
              } else if (!p.passed) {
                // Di gap & bentuk benar → tambah skor
                p.passed = true;
                score++;
                scoreText.textContent = score;
              }
            }
          }

          // Hapus pipe yang sudah lewat layar
          if (p.x + pipeWidth < 0) {
            pipes.splice(i, 1);
          }
        }
      }

      draw();
      requestAnimationFrame(update);
    }

    function triggerGameOver() {
      if (gameOver) return;
      gameOver = true;
      gameRunning = false;
      overlay.style.opacity = 1;
      titleText.textContent = "Game Over";
      subText.innerHTML = `Skor kamu: ${score}<br/>Tekan ENTER untuk restart`;
    }

    function drawPlayer() {
      ctx.save();
      ctx.translate(player.x, player.y);

      // Body outline
      ctx.lineWidth = 3;
      ctx.strokeStyle = "#000";

      if (player.shape === "circle") {
        ctx.fillStyle = "#ffe066";
        ctx.beginPath();
        ctx.arc(0, 0, player.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
      } else if (player.shape === "square") {
        ctx.fillStyle = "#ff6b6b";
        const size = player.radius * 2 * 0.9;
        ctx.beginPath();
        ctx.rect(-size / 2, -size / 2, size, size);
        ctx.fill();
        ctx.stroke();
      } else if (player.shape === "triangle") {
        ctx.fillStyle = "#4ecdc4";
        const size = player.radius * 2;
        ctx.beginPath();
        ctx.moveTo(-size / 2, size / 2);
        ctx.lineTo(0, -size / 2);
        ctx.lineTo(size / 2, size / 2);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
      }

      // Simple eye
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.arc(player.radius / 4, -player.radius / 4, 3, 0, Math.PI * 2);
      ctx.fill();

      ctx.restore();
    }

    function drawPipe(p) {
      ctx.fillStyle = "#2ecc71";
      ctx.strokeStyle = "#1e6e3b";
      ctx.lineWidth = 2;

      // Top pipe
      ctx.beginPath();
      ctx.rect(p.x, 0, pipeWidth, p.gapY);
      ctx.fill();
      ctx.stroke();

      // Bottom pipe
      ctx.beginPath();
      ctx.rect(p.x, p.gapY + p.gapHeight, pipeWidth, H - (p.gapY + p.gapHeight));
      ctx.fill();
      ctx.stroke();

      // Gap highlight / portal
      ctx.save();
      const centerX = p.x + pipeWidth / 2;
      const centerY = p.gapY + p.gapHeight / 2;

      ctx.translate(centerX, centerY);
      ctx.fillStyle = "rgba(255,255,255,0.5)";
      ctx.beginPath();
      ctx.rect(-pipeWidth / 2, -p.gapHeight / 2, pipeWidth, p.gapHeight);
      ctx.fill();

      // Icon bentuk yang diminta
      ctx.lineWidth = 3;
      ctx.strokeStyle = "#000";
      ctx.fillStyle = "#f1c40f";
      const iconSize = 24;

      if (p.requiredShape === "circle") {
        ctx.beginPath();
        ctx.arc(0, 0, iconSize / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
      } else if (p.requiredShape === "square") {
        ctx.beginPath();
        ctx.rect(-iconSize / 2, -iconSize / 2, iconSize, iconSize);
        ctx.fill();
        ctx.stroke();
      } else if (p.requiredShape === "triangle") {
        ctx.beginPath();
        ctx.moveTo(-iconSize / 2, iconSize / 2);
        ctx.lineTo(0, -iconSize / 2);
        ctx.lineTo(iconSize / 2, iconSize / 2);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawBackground() {
      // Ground
      ctx.fillStyle = "#27ae60";
      ctx.fillRect(0, H - 60, W, 60);
      ctx.fillStyle = "#2ecc71";
      ctx.fillRect(0, H - 55, W, 55);

      // Some clouds
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      for (let i = 0; i < 3; i++) {
        const baseX = (Date.now() / 50 + i * 150) % (W + 100) - 50;
        const baseY = 80 + i * 60;
        ctx.beginPath();
        ctx.arc(baseX, baseY, 25, 0, Math.PI * 2);
        ctx.arc(baseX + 20, baseY - 10, 20, 0, Math.PI * 2);
        ctx.arc(baseX - 20, baseY - 10, 20, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function draw() {
      ctx.clearRect(0, 0, W, H);
      drawBackground();

      // Pipes
      pipes.forEach(drawPipe);

      // Player
      drawPlayer();
    }

    // Input: keyboard
    window.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        flap();
      } else if (e.code === "Digit1") {
        changeShape(0);
      } else if (e.code === "Digit2") {
        changeShape(1);
      } else if (e.code === "Digit3") {
        changeShape(2);
      } else if (e.code === "Enter") {
        if (gameOver) resetGame();
      }
    });

    // Input: mouse / touch
    canvas.addEventListener("mousedown", flap);
    canvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      flap();
    });

    // Mulai
    resetGame();
    update();
  </script>
</body>
</html>
